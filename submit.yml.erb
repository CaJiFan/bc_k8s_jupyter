<%
   pwd_cfg = "c.NotebookApp.password=u\'sha1:${SALT}:${PASSWORD_SHA1}\'"
   host_port_cfg = "c.NotebookApp.base_url=\'/node/${HOST_CFG}/${PORT_CFG}/\'"
   log_lvl_cfg = "c.Application.log_level='DEBUG'"
   ip_cfg = "c.NotebookApp.ip = '*'"
   xsrf_cfg = "c.NotebookApp.disable_check_xsrf = True"
   origin_cfg = "c.NotebookApp.allow_origin = '*'"

   configmap_filename = "ondemand_config.py"
   configmap_data = "c.NotebookApp.port = 8080"
%>
---
script:
  native:
    container:
      name: "jupyter"
      image: "jupyter/scipy-notebook"
      command: "/opt/conda/bin/jupyter notebook --config=/ood/ondemand_config.py"
      port: "8080"
    configmap:
      filename: "<%= configmap_filename %>"
      data: "<%= configmap_data %>"
    init_ctrs:
    - name: "init-secret"
      image: "jeffohrstrom/ood-k8s-utils:latest"
      command: 
      - "/bin/save_passwd_as_secret" 
      - "<%= ENV['USER'] %>"
    - name: "add-passwd-to-cfg"
      image: "jeffohrstrom/ood-k8s-utils:latest"
      command:
      - "/bin/bash"
      - "-c"
      - "source /bin/create_salt_and_sha1; /bin/add_line_to_configmap \\\"<%= pwd_cfg %>\\\" <%= configmap_filename %>"
    - name: "add-hostport-to-cfg"
      image: "jeffohrstrom/ood-k8s-utils:latest"
      command:
      - "/bin/bash"
      - "-c"
      - "source /bin/find_host_port; /bin/add_line_to_configmap \\\"<%= host_port_cfg %>\\\" <%= configmap_filename %>"
    - name: "add-loglvl-to-cfg"
      image: "jeffohrstrom/ood-k8s-utils:latest"
      command:
      - "/bin/add_line_to_configmap"
      - "<%= log_lvl_cfg %>"
      - "<%= configmap_filename %>"
    - name: "add-ip-to-cfg"
      image: "jeffohrstrom/ood-k8s-utils:latest"
      command:
      - "/bin/add_line_to_configmap"
      - "<%= ip_cfg %>"
      - "<%= configmap_filename %>"
    - name: "add-xsrf-to-cfg"
      image: "jeffohrstrom/ood-k8s-utils:latest"
      command:
      - "/bin/add_line_to_configmap"
      - "<%= xsrf_cfg %>"
      - "<%= configmap_filename %>"
    - name: "add-origin-to-cfg"
      image: "jeffohrstrom/ood-k8s-utils:latest"
      command:
      - "/bin/add_line_to_configmap"
      - "<%= origin_cfg %>"
      - "<%= configmap_filename %>"
